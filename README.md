# PFMDS

## Parallel Fortran Molecular Dynamics Simulation

"Real Programmers use FORTRAN."

"If you can’t do it in FORTRAN, do it in assembly language. If you can’t do it in assembly language, it isn’t worth doing."

(Ed Post, Datamation Volume 29 number 7 July 1983)

## Что это?

Это набор программ для молекулярной динамики (МД), подгона потенциалов и анализа результатов. Детали в пункте "Как пользоваться?"

Поддерживается OpenMP параллелизм. Несколько независимых прогонов МД могут быть запущены параллельно с помощью MPI.

### run_md_simulation

Моделирование методом МД.

Потенциалы:

* ржл
* тб
* ребо
* лдж
* ....

Интеграторы:

* Верле в скоростной форме
* Верле в скоростной форме с цепочкой термостатов Нозе-Гувера (пока возможно применение только одной цепочки)
* Молекулярная статика

### run_gr_moire_fitting

Подгон параметров модифицированных потенциалов Леннарда-Джонса или Морзе.

### run_gr_analysis

Анализ расположения графена на поверхности меди.

## Дополнительный софт

### Компилятор

* ifort

Работает без проблем (проверено на кластере Ломоносов-1), но с gfortran программа получается быстрее, это вопрос оптимизации.

* gfortran 

В gfortran версии 4.4 есть баг при аллокации omp private массивов в параллельной части программы. Рекомендуется использовать более поздние версии (проверено с gcc version 6.3.0).

### Просмотр .xyz файлов

Для информации о атомах в вычислительной ячейки испльзован формат .xyz (http://libatoms.github.io/QUIP/io.html#module-ase.io.extxyz). Просматривать можно, например, с помощью [OVITO](https://ovito.org).

## Как компилировать?

* Linux

Запустить скрипт unix_bash_compile.sh в папке code_source
```
sh unix_bash_compile.sh
```

* Windows

Запустить скрипт windows_compile.cmd в папке code_source

Изменить испльзуемый компилятор, путь к нему, опции компиляции и т. д. можно внутри этих скриптов.

Исполняемые файлы появятся в папке executables.

## Как пользоваться?

Исполняемые файлы в папке executables - результат компиляции программ в папке code_source/runnes, в которых вызываются необходимые подпрограммы. Основной и самой сложной является подпрограмма md(), с ее помощью и проводится моделирование.

Описание входных переменных, входных и выходных файлов и настроек моделирования для подпрограммы md(). 

### Входные переменные 
См. md()

### Возвращаемые переменные 
md() ничего не возвращает.

### Входные файлы

* Файл настроек (settings_filename)

Имеет фиксированный порядок строк и переменных в строках, который определяется порядком чтения в md().

Названия параметров в файле настроек не проверяются при чтении. Единственное что важно, это порядок! 

Пример 1. Л-Дж жидкость (или газ) из атомов A.
```
md_step_limit:				5000
logfilename:				md_run.log
init_xyz_filename:			A_atoms.xyz
new_velocities:				F
zero_momentum_period:		1000000
particle_types_num:			1
groups_num:					2
	1		A	
	2		#	
all_moving_atoms_group_num:		1
xyz_moving_atoms_group_num:		1
z_moving_atoms_group_num:		2
termo_atoms_group_num:		2
all_atoms_group_num:		1
traj_group_num:				2
period_traj:				50
change_group_num:			0
invert_z_vel:				F
integrators_num:			1
 name    dt         len     snap     log
 nve     0.25000    3000000 500000000    1000
ms_de:						1.e-8
nhc_params:					300.	3	10000.
initial_temerature:			300.
interactions_num:			1
??????
```

md_step_limit - лимит шагов МД.

logfilename - имя файла для регулярного вывода энергий и температуры.

init_xyz_filename - имя .xyz файла с начальными расположениями и скоростями атомов.

new_velocities - T или F, присваивать ли атомам новые скорости. Если T, то атомы из группы all_moving_atoms_group_num будут иметь скорости, распределенные по Максвеллу для температуры initial_temerature.

zero_momentum_period - период обнуления скорости центра масс группы атомов all_atoms_group_num. При долгих временах моделирования могут накопиться ошибки. Угловые скорости не обнуляются.

particle_types_num - количество рассматриваемых типов атомов.

groups_num - количество групп атомов. Один атом может входить в несколько групп или не входить ни в одну. Скорее всего понадобится пустая группа.

После groups_num идет таблица с groups_num строками и particle_types_num+1 столбцами. Первый столбец - вспомогательный, рекомендуется писать в него номера строк, они же номера групп. Остальные столбцы - имена атомов.

all_moving_atoms_group_num - номер группы со всеми двигающимися атомами.

xyz_moving_atoms_group_num - номер группы с атомами, двигающимися во всех направлениях

z_moving_atoms_group_num - номер группы с атомами, двигающимися только по оси Z. Группы xyz_moving_atoms_group_num и z_moving_atoms_group_num не должны пересекаться! Термостат не учитывает уменьшение количества степеней свободы для этих атомов!

termo_atoms_group_num - термостатируемая группа атомов.

all_atoms_group_num - группа со всеми моделируемыми атомами.

traj_group_num - группа атомов для вывода положений атомов в один файл каждые period_traj шагов МД.

period_traj - период вывода положений атомов из группы traj_group_num.

change_group_num - количество групп с изменяемым количеством атомов (для добавления атомов в ячейку). Если не 0, то см ????????.

invert_z_vel - T или F, создать или нет абсолютно упругую стенку в верхней части ячейки (для предотвращения прохода атомов через Z границу ячейки)

integrators_num - количество интеграторов.

Далее идет вспомогательная строка.

Далее integrators_num строк с названием интегратора, шагом интегрирования, количеством шагов, периодом вывода положений и скоростей атомов в отдельный файл и периодом вывода в logfilename.

ms_de - разница энергии для остановки молекулярной статики.

nhc_params - параметры цепочки термостатов Нозе-Гувера: температура, количество звеньев и масса первого звена.

initial_temerature - начальная температура группы all_moving_atoms_group_num если в new_velocities указано T.

interactions_num - количество взаимодействий между атомами.

Далее interactions_num блоков с параметрами для каждого взаимодействия. ??????

## Контакты

e-mail av.sidorenkov@physics.msu.ru

github https://github.com/AlexanderSidorenkov
